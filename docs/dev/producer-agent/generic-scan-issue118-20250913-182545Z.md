# Producer Agent – Generic Scan (Issue #118)

## Context

- Repo: a5c-ai/events
- Trigger: Issue comment mention "@producer-agent do a generic scan"
- Branch: chore/producer-generic-scan-issue118-<timestamp>

## Phase Assessment

- Current phase file: docs/producer/phases/current-phase.txt → Specification Phase
- Checklist: docs/producer/phases/specification-phase/checklist.md – complete
- Technical specs present under docs/producer/phases/technical-specs/_ and docs/specs/_

Conclusion: Transition to Technical Specification → Scaffolding/Development phases is underway in code; specs exist and tests exist.

## Implementation Scan (highlights)

- CLI commands: `events mentions|normalize|enrich` implemented in src/cli.ts
- Normalization: src/providers/github/map.ts maps GitHub events → NE schema
- Enrichment: src/enrichGithubEvent.js with Octokit, codeowners, diffs, branch protection
- Mentions: src/extractor.ts with schema and tests
- Redaction: src/utils/redact.ts with patterns
- Tests: Vitest + node:test present, schema validation in tests/normalize.test.ts
- Workflows: a5c.yml (router), main.yml (build/test), tests.yml, lint.yml, release.yml, deploy.yml

## Spec ↔ Impl Gaps

1. CLI docs vs flags mismatches
   - Specs reference `--provider github`, code uses implicit provider and `--source` plus labels. Missing docs for `--flag`, `--use-github`.
   - Acceptance: Align docs to actual flags or add aliases in CLI to match specs.

2. Mentions in code comments across changed files
   - Specs call for language-aware scanning of code comments; current extractor handles text sources only. No file scanning routine or language filters implemented.
   - Acceptance: Implement file scanning per changed files with size caps and language detection; add tests.

3. Enrichment: PR conflict boolean
   - Specs require `has_conflicts` boolean; code exposes `mergeable_state` but not explicit boolean in NE.
   - Acceptance: Derive `has_conflicts` and surface under enriched.github.pr.has_conflicts.

4. Branch protection details subset
   - Only raw response stored; specs ask for key flags extraction (e.g., required checks, linear_history) – could be normalized fields.
   - Acceptance: Map branch protection to concise flags structure with fallbacks.

5. Configuration docs
   - Env precedence implemented (`A5C_AGENT_GITHUB_TOKEN` → `GITHUB_TOKEN`), but docs need explicit section in README/CLI reference.
   - Acceptance: Update docs/specs and docs/cli to reflect config and safety notes.

6. Examples consistency
   - Specs show `npx @a5c/events` scope while package name is `@a5c-ai/events`; ensure docs and pkg are consistent.
   - Acceptance: Update docs examples or add `publishConfig` alias guidance.

7. Tests coverage for enrich flags
   - include_patch default true in code; specs default false. Add flag tests and reconcile default.

## Proposed Issues

- [Producer] CLI – Align flags with specs (docs or code aliases)
- [Producer] Mentions – Implement code comment scanning over changed files
- [Producer] Enrich – Add pr.has_conflicts and normalize branch protection flags
- [Producer] Docs – Config and tokens section; fix package scope in examples
- [Producer] Tests – Enrich flags coverage and defaults reconciliation

## Next Steps

- Open issues with labels: producer, cli, functionality, documentation, tests
- Update phase if specification checklist is effectively complete → move to technical-specs or scaffolding checklist sync
