#!/usr/bin/env sh
set -e

echo "Running pre-commit checks (lint-staged)..."
if command -v npx >/dev/null 2>&1 && [ -f package.json ]; then
  # Allow skipping via env variable
  if [ -n "$A5C_SKIP_PRECOMMIT" ] || [ -n "$SKIP_PRECOMMIT" ]; then
    echo "Skipping pre-commit due to env flag."
  else
    # Run lint-staged; if it fails (lint errors), block the commit
    npx --no-install lint-staged || npx lint-staged
  fi
fi

# Guard against Windows-invalid filenames (e.g., ':')
if git diff --cached --name-only | grep -E ':' >/dev/null 2>&1; then
  echo "\n\033[31mError: staged filenames contain ':' which breaks Windows checkouts.\033[0m"
  echo "Please rename to use '-' instead."
  git diff --cached --name-only | grep -E ':' || true
  exit 1
fi
