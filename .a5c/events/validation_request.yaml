---
on:
  any:
    filters:
      - expression: ${{ env.VALIDATION_REQUEST_IN_PROGRESS_WARNING == 'true' && event.type == 'synchronize' && event.pull_request.labels | map(name) | contains('validation') }}
script:
  - |
    echo "PR branch changed while validation is in progress - ${{ event.pull_request.html_url }}"
---
on:
  pull_request:
    filters:
      - expression: ${{ event.pull_request.labels | map(name) | contains('validation') && event.type == 'ready_for_review' }}
emit:
  pull_request_ready_for_review:
    type: ready_for_review
    payload:
      original_event: ${{ event }}
      pr_ref: ${{ event.pull_request.head.ref }}
      base_ref: ${{ event.pull_request.base.ref }}
      pull_request: ${{ event.pull_request }}
set_labels:
  - entity: ${{ event.pull_request.html_url }}
    add_labels: [validation_requested]
    remove_labels: [validated]
script:
  - |
    echo "Validation request for PR ${{ event.pull_request.html_url }} added label validation"
---
on:
  pull_request_ready_for_review:
    filters:
      - expression: ${{ event.pull_request.labels | map(name) | contains('validation') }}
emit:
  validation_request:
    type: created
    payload:
      original_event: ${{ event.original_event }}
      pull_request: ${{ event.pull_request }}
      ref: ${{ event.ref }}
---
on:
  validation_request:
pre_set_labels:
  - entity: ${{ event.pull_request.html_url }}
    add_labels: [validation_in_progress]
    remove_labels: [validation_requested]
metadata:
  # for running the reactor with --metadata-match runner-name=validation-runner
  runner-name: validation-runner
env:
  - name: A5C_MCPS_PATH
    value: ${{ vars.A5C_MCPS_PATH || '~/.a5c/mcps.json' }}
  - name: A5C_TEMPLATE_URI
    value: ${{ env.A5C_TEMPLATE_URI || vars.A5C_TEMPLATE_URI  || event.client_payload.template || 'github://a5c-ai/events/branch/a5c%2Fmain/.a5c/main.md' }}
script:
  - |
    echo "running agent for validation"
    # npx -y @a5c-ai/events@latest generate_context --in ${{ event_path }} \
    #    --template ${{ env.A5C_TEMPLATE_URI }} \
    #    --out - | npx -y @a5c-ai/runner run --cli=codex --prompt-file=- --mcps=~/.a5c/mcps.json
set_labels:
  - entity: ${{ event.pull_request.html_url }}
    add_labels: [validated]
    remove_labels: [validation_in_progress]
