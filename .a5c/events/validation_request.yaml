---
name: Validation Request
metadata:
  runner-name: reactor
on:
  any:
    filters:
      - expression: ${{ env.A5C_GLOBAL_HANDLER == 'true' }}
    skip:
      - expression: ${{ event.labels | contains('a5c') == false }}
script:
  - |
    echo "Global handler for 'any' for events containing 'a5c' label"
---
name: Validation Request In Progress Warning
metadata:
  runner-name: reactor
on:
  any:
    filters:
      - expression: ${{ env.VALIDATION_REQUEST_IN_PROGRESS_WARNING == 'true' && event.type == 'synchronize' && event.labels | contains('validation') }}

script:
  - |
    echo "PR branch changed while validation is in progress - ${{ event.pull_request.html_url }}"
---
name: Validate PRs by validation label
metadata:
  runner-name: reactor
on:
  pull_request:
    filters:
      # PR is ready for review, opened, reopened
      - expression: ${{ (event.type == 'opened' || event.type == 'reopened' || event.type == 'ready_for_review')}}
      # validation label was added
      - expression: ${{ event.type == 'labeled' && event.label.name == 'validation' }}
    skip:
      # is a draft PR or already merged
      - expression: ${{ event.pull_request.draft == true || event.pull_request.merged == true }}
      # doesn't have the 'validation' label
      - expression: ${{ event.labels | contains('validation') == false || event.label.name != 'validation' }}
      # if validation in progress or already requested
      - expression: ${{ event.labels | contains('validation_in_progress') || event.labels | contains('validation_requested') }}
emit:
  validation_request:
    type: pr_ready
    payload:
      original_event: ${{ event }}
      pr_ref: ${{ event.pull_request.head.ref }}
      base_ref: ${{ event.pull_request.base.ref }}
      pull_request: ${{ event.pull_request }}
set_labels:
  - entity: ${{ event.pull_request.html_url }}
    add_labels: [validation_requested]
    remove_labels: [validated]
script:
  - |
    echo "Validation request for PR ${{ event.pull_request.html_url }} added label validation"
---
name: Validation Agent Run
metadata:
  runner-name: agents
on:
  validation_request:
pre_set_labels:
  - entity: ${{ event.pull_request.html_url }}
    add_labels: [validation_in_progress]
    remove_labels: [validation_requested]
env:
  - name: A5C_MCPS_PATH
    value: ${{ vars.A5C_MCPS_PATH || '~/.a5c/mcps.json' }}
  - name: A5C_TEMPLATE_URI
    value: ${{ env.A5C_TEMPLATE_URI || vars.A5C_TEMPLATE_URI  || event.client_payload.template || 'github://a5c-ai/events/branch/a5c%2Fmain/.a5c/main.md' }}
status-checks:
  - name: Validation/{{ event.type }}
    # sets state in queued / running before running script, and state: success/failure after (depending on the script shell return value)
    description: Validation of PR ({{ event.pull_request.title }})
    pull_request_url: ${{ event.pull_request.html_url }}
script:
  - |
    echo "running agent for validation"
    npx -y "$A5C_PKG_SPEC" generate_context \
      --in "$A5C_EVENT_PATH" \
      --template "$A5C_TEMPLATE_URI" \
      --out /tmp/prompt.md
    cat /tmp/prompt.md
    npx -y "$A5C_PKG_SPEC" run \
      --in /tmp/prompt.md \
      --out /tmp/out.json \
      --profile azure_codex_gpt5 \
      --mcps "${A5C_MCPS_PATH:-~/.a5c/mcps.json}"
    cat /tmp/out.json
set_labels:
  - entity: ${{ event.pull_request.html_url }}
    add_labels: [validated]
    remove_labels: [validation_in_progress]
