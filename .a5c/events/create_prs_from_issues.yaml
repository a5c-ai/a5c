---
name: Create PRs from Issues
metadata:
  runner-name: reactor
on:
  issues:
    filters:
      # issue is opened, reopened
      - expression: ${{ (event.type == 'opened' || event.type == 'reopened')}}
      # label create_pr was added
      - expression: ${{ event.type == 'labeled' && event.label.name == 'create_pr' }}
      # triage enabled in this repo on the a5c/main branch (can be current or event.repository.default_branch) - reads from github content for the current branch (read_github_content fallback to empty string)
      - expression: ${{ read_github_content(event.repository.html_url, "a5c/main", '.a5c/create_pr.yaml') | load_yaml | select('create_pr.enabled') }}
    skip:
      # is a issue or already closed
      - expression: ${{ event.issue.closed == true }}
      # doesn't have the 'create_pr' label
      - expression: ${{ event.labels | contains('create_pr') == false || event.label.name != 'create_pr' }}
      # if triage in progress or already requested
      - expression: ${{ event.labels | contains('create_pr_in_progress') || event.labels | contains('create_pr_requested') }}
emit:
  create_pr_from_issue:
    type: issue_ready_for_triage
    payload:
      original_event: ${{ event }}
      issue: ${{ event.issue }}
set_labels:
  - entity: ${{ event.issue.html_url }}
    add_labels: [create_pr_requested]
    remove_labels: [created_pr]
script:
  - |
    echo "Create PR request for issue ${{ event.issue.html_url }} added label create_pr"
---
name: Create PR Agent Run
metadata:
  runner-name: reactor
on:
  create_pr_from_issue:
pre_set_labels:
  - entity: ${{ event.issue.html_url }}
    add_labels: [create_pr_in_progress]
    remove_labels: [create_pr_requested]
env:
  - name: HEAD_BRANCH
    value: issue/a5c/{{ event.issue.number }}
  - name: BASE_BRANCH
    value: a5c/main
  - name: PR_TITLE
    value: ${{ event.issue.title }}
  - name: PR_BODY
    value: ${{ event.issue.body }}
  - name: PR_LABELS
    value: "${{ event.issue.labels | map(attribute='name') | join(',') }},created_from_issue"
  - name: PR_DRAFT
    value: true
  - name: INITIAL_COMMIT_MESSAGE
    value: "${{ event.issue.title }} - initial commit"
  - name: INITIAL_COMMIT_FILE_CONTENT
    value: ${{ event.issue.body }}
  - name: INITIAL_COMMIT_FILE_NAME
    value: /docs/issues/issue-${{ event.issue.number }}.md
script_template_uri: github://a5c-ai/events/branch/a5c%2Fmain/.a5c/create-pr.sh #optional - falls back to ${{ env.A5C_AGENT_SCRIPT_URI || vars.A5C_AGENT_SCRIPT_URI || 'github://a5c-ai/events/branch/a5c%2Fmain/.a5c/agent.sh' }}
set_labels:
  - entity: ${{ event.issue.html_url }}
    add_labels: [created_pr]
    remove_labels: [create_pr_in_progress]
---
name: Release - merge a5c/main to main
metadata:
  runner-name: reactor
on:
  merge_a5c_main_to_main:
env:
  - name: HEAD_BRANCH
    value: a5c/main
  - name: BASE_BRANCH
    value: main
  - name: PR_TITLE
    value: "Merge a5c"
  - name: PR_BODY
    value: "Merge a5c"
  - name: PR_LABELS
    value: "release"
  - name: PR_DRAFT
    value: true
script_template_uri: github://a5c-ai/events/branch/a5c%2Fmain/.a5c/create-pr.sh
---
name: Rebase - merge main to a5c/main
metadata:
  runner-name: reactor
on:
  rebase_main_to_a5c_main:
env:
  - name: HEAD_BRANCH
    value: main
  - name: BASE_BRANCH
    value: a5c/main
  - name: PR_TITLE
    value: "Rebase a5c"
  - name: PR_BODY
    value: "Rebase a5c"
  - name: PR_LABELS
    value: "rebase"
  - name: PR_DRAFT
    value: true
script_template_uri: github://a5c-ai/events/branch/a5c%2Fmain/.a5c/create-pr.sh
