---
name: Triage New Issues
metadata:
  runner-name: reactor
on:
  issues:
    filters:
      # issue is opened, reopened
      - expression: ${{ (event.type == 'opened' || event.type == 'reopened')}}
      # label triage was added
      - expression: ${{ event.type == 'labeled' && event.label.name == 'triage' }}
      # triage enabled in this repo on the a5c/main branch (can be current or event.repository.default_branch) - reads from github content for the current branch (read_github_content fallback to empty string)
      - expression: ${{ read_github_content(event.repository.html_url, "a5c/main", '.a5c/triage.yaml') | load_yaml | select('triage.enabled') }}
    skip:
      # is a issue or already closed
      - expression: ${{ event.issue.closed == true }}
      # doesn't have the 'triage' label
      - expression: ${{ event.labels | contains('triage') == false || event.label.name != 'triage' }}
      # if triage in progress or already requested
      - expression: ${{ event.labels | contains('triage_in_progress') || event.labels | contains('triage_requested') }}
emit:
  triage_new_issue:
    type: issue_ready_for_triage
    payload:
      original_event: ${{ event }}
      issue: ${{ event.issue }}
set_labels:
  - entity: ${{ event.issue.html_url }}
    add_labels: [triage_requested]
    remove_labels: [triaged]
script:
  - |
    echo "Triage request for issue ${{ event.issue.html_url }} added label triage"
---
name: Triage Agent Run
metadata:
  runner-name: agents
on:
  triage_new_issue:
pre_set_labels:
  - entity: ${{ event.issue.html_url }}
    add_labels: [triage_in_progress]
    remove_labels: [triage_requested]
agent_run:
  envs:
    # added to the env vars section
    - name: SOME_ENV
      value: some_value
  template: github://a5c-ai/events/branch/a5c%2Fmain/.a5c/main.md #optional - falls back to ${{ env.A5C_TEMPLATE_URI || vars.A5C_TEMPLATE_URI  || event.client_payload.template || 'github://a5c-ai/events/branch/a5c%2Fmain/.a5c/main.md' }}
  mcps: "~/.cursor/mcps.json" #optional - falls back to ${{ env.A5C_MCPS_PATH || vars.A5C_MCPS_PATH || '~/.a5c/mcps.json' }}
  profile: azure_codex_gpt5 #optional - falls back to ${{ env.A5C_CLI_PROFILE || vars.A5C_CLI_PROFILE || 'codex' }}
  # overrides the script_template_uri from the root section of this handler
  script_template_uri: github://a5c-ai/events/branch/a5c%2Fmain/.a5c/agent.sh #optional - falls back to ${{ env.A5C_AGENT_SCRIPT_URI || vars.A5C_AGENT_SCRIPT_URI || 'github://a5c-ai/events/branch/a5c%2Fmain/.a5c/agent.sh' }}
set_labels:
  - entity: ${{ event.issue.html_url }}
    add_labels: [triaged]
    remove_labels: [triage_in_progress]
