---
name: Triage New Issues
on:
  issues:
    filters:
      # issue is opened, reopened
      - expression: ${{ (event.type == 'opened' || event.type == 'reopened')}}
      # label triage was added
      - expression: ${{ event.type == 'labeled' && event.label.name == 'triage' }}
    skip:
      # is a issue or already closed
      - expression: ${{ event.issue.closed == true }}
      # doesn't have the 'triage' label
      - expression: ${{ event.labels | contains('triage') == false || event.label.name != 'triage' }}
      # if triage in progress or already requested
      - expression: ${{ event.labels | contains('triage_in_progress') || event.labels | contains('triage_requested') }}
emit:
  triage_new_issue:
    type: issue_ready_for_triage
    payload:
      original_event: ${{ event }}
      issue: ${{ event.issue }}
set_labels:
  - entity: ${{ event.issue.html_url }}
    add_labels: [triage_requested]
    remove_labels: [triaged]
script:
  - |
    echo "Triage request for issue ${{ event.issue.html_url }} added label triage"
---
on:
  triage_new_issue:
pre_set_labels:
  - entity: ${{ event.issue.html_url }}
    add_labels: [triage_in_progress]
    remove_labels: [triage_requested]
metadata:
  # for running the reactor with --metadata-match runner-name=triage-runner
  runner-name: triage-runner
env:
  - name: A5C_MCPS_PATH
    value: ${{ vars.A5C_MCPS_PATH || '~/.a5c/mcps.json' }}
  - name: A5C_TEMPLATE_URI
    value: ${{ env.A5C_TEMPLATE_URI || vars.A5C_TEMPLATE_URI  || event.client_payload.template || 'github://a5c-ai/events/branch/a5c%2Fmain/.a5c/main.md' }}
script:
  - |
    set -euo pipefail
    echo "running agent for triage"
    npx -y "$A5C_PKG_SPEC" generate_context \
      --in "$A5C_EVENT_PATH" \
      --template "$A5C_TEMPLATE_URI" \
      --out /tmp/prompt.md
    cat /tmp/prompt.md
    npx -y "$A5C_PKG_SPEC" run \
      --in /tmp/prompt.md \
      --out /tmp/out.json \
      --profile azure_codex_gpt5 \
      --mcps "${A5C_MCPS_PATH:-~/.a5c/mcps.json}"
    cat /tmp/out.json
set_labels:
  - entity: ${{ event.issue.html_url }}
    add_labels: [triaged]
    remove_labels: [triage_in_progress]
