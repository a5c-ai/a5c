name: Commit Hygiene

on:
  pull_request:
    branches: [ a5c/main ]
    types: [opened, synchronize, edited, reopened]

jobs:
  commit-hygiene:
    name: Conventional Commits validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install lightweight deps
        run: |
          npm ci --omit=dev || npm i --omit=dev || true
          # ensure tsx available; fallback to dev if needed
          npm i -D tsx@^4.19.1 || true
      - name: Validate PR title
        run: |
          TITLE=$(jq -r .pull_request.title < "$GITHUB_EVENT_PATH")
          npx -y tsx scripts/commit-verify.ts --pr-title "$TITLE" --allow-merge
      - name: Validate commit messages in PR
        run: |
          BASE_SHA=$(jq -r .pull_request.base.sha < "$GITHUB_EVENT_PATH")
          HEAD_SHA=$(jq -r .pull_request.head.sha < "$GITHUB_EVENT_PATH")
          git fetch --depth=200 origin 
          git log --format=%s "$BASE_SHA..$HEAD_SHA" | while IFS= read -r line; do
            # allow merge commits through
            npx -y tsx scripts/commit-verify.ts --message "$line" --allow-merge || exit 1
          done

