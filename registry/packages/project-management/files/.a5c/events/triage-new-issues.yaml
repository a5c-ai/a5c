---
name: Auto triage new issues
metadata:
  runner-name: reactor
on:
  issue:
    filters:
      - expression: ${{ event.type == 'opened' }}
    skip:
      - expression: ${{ env.A5C_EVENTS_AUTO_TRIAGE_NEW_ISSUES == 'false' }}
actions:
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [triage]
  - type: add_comment
    params:
      issue: ${{ event.issue.html_url }}
      comment: "Triage requested for issue #${{ event.issue.number }}"
---
name: Manual triage via label or slash command
metadata:
  runner-name: reactor
on:
  issue:
    filters:
      # triage label added or slash command invoked
      - expression: ${{ event.type == 'labeled' && event.label.name == 'issue_triage' }}
      - expression: ${{ event.enriched.slash_commands | default([]) | map(attribute='command') | contains('issue-triage') }}
    skip:
      # is a issue or already closed
      - expression: ${{ event.issue.closed == true }}
      # if triage in progress or already requested
      - expression: ${{ event.issue.labels | map(attribute='name') | contains('issue_triage_in_progress') || event.issue.labels | map(attribute='name') | contains('issue_triage_queued') }}
emit:
  issue_triage_requested:
    type: issue_triage
    payload:
      original_event: ${{ event }}
      issue: ${{ event.issue }}
      among: 
        - 'bug'
        - 'feature'
        - 'documentation'
        - 'question'
        - 'enhancement'
        - 'devops'
        - 'security'
        - 'performance'
        - 'ux'
        - 'backend'
        - 'frontend'
        - 'database'
        - 'api'
        - 'infrastructure'
        - 'support'
        - 'feature_request'
actions:
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [issue_triage_queued]
      remove_labels: [issue_triage_completed]
---
name: Issue triage agent run
metadata:
  runner-name: agents
on:
  issue_triage_requested:
actions:
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [issue_triage_in_progress]
      remove_labels: [issue_triage_queued]
  - type: agent_run
    env:
      - name: SOME_ENV
        value: some_value
    params: {}
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [issue_triage_completed]
      remove_labels: [issue_triage_in_progress]
