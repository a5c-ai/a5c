---
name: Implement PRs by implement_pr label
metadata:
  runner-name: reactor
on:
  pull_request:
    filters:
      # implement_pr label was added
      - expression: ${{ event.type == 'labeled' && event.label.name == 'implement_pr' }}
    skip:
      # is already merged
      - expression: ${{ event.pull_request.merged == true }}
      # if implement_pr in progress or already requested
      - expression: ${{ event.payload.client_payload.payload.pull_request.labels | map(attribute='name') | contains('implement_pr_in_progress') || event.payload.client_payload.payload.pull_request.labels | map(attribute='name') | contains('implement_pr_requested') }}
emit:
  implement_pr_request:
    type: pr_implement
    payload:
      original_event: ${{ event }}
      pr_ref: ${{ event.pull_request.head.ref }}
      base_ref: ${{ event.pull_request.base.ref }}
      pull_request: ${{ event.pull_request }}
set_labels:
  - entity: ${{ event.pull_request.html_url }}
    add_labels: [implement_pr_requested]
    remove_labels: [implemented]
---
name: Implement PR Agent Run
metadata:
  runner-name: agents
on:
  implement_pr_request:
pre_set_labels:
  - entity: ${{ event.pull_request.html_url }}
    add_labels: [implement_pr_in_progress]
    remove_labels: [implement_pr_requested]
status-checks:
  - name: Implement PR/{{ event.type }}
    # sets state in queued / running before running script, and state: success/failure after (depending on the script shell return value)
    description: Implement PR ({{ event.pull_request.title }})
    pull_request_url: ${{ event.pull_request.html_url }}
agent_run:
  envs:
    - name: SOME_ENV
      value: some_value
set_labels:
  - entity: ${{ event.pull_request.html_url }}
    add_labels:
      - implemented
      # - validate
    remove_labels: [implement_pr_in_progress]
