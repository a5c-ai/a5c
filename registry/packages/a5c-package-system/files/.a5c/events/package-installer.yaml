---
name: Install a5c packages via slash command
metadata:
  runner-name: reactor
on:
  issue:
    filters:
      # a5c package label was added or slash command invoked
      - expression: ${{ event.type == 'labeled' && event.label.name == 'package_install' }}
      - expression: ${{ event.enriched.slash_commands | map(command) | contains('install-packages') }}
    skip:
      # is a issue or already closed
      - expression: ${{ event.issue.closed == true }}
      # if a5c package installer in progress or already requested
      - expression: ${{ event.issue.labels | map(attribute='name') | contains('package_install_in_progress') || event.issue.labels | map(attribute='name') | contains('package_install_queued') }}
emit:
  package_install_requested:
    type: package_installation
    payload:
      original_event: ${{ event }}
      issue: ${{ event.issue }}
actions:
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [package_install_queued]
---
name: Install a5c packages agent run
metadata:
  runner-name: agents
on:
  package_install_requested:
# pre_set_labels:
#   - entity: ${{ event.issue.html_url }}
#     add_labels: [a5c_package_installer_in_progress]
#     remove_labels: [a5c_package_installer_requested]
# set_labels:
#   - entity: ${{ event.issue.html_url }}
#     add_labels: [a5c_package_installer_installed]
#     remove_labels: [a5c_package_installer_in_progress]
# agent_run:  
#   envs:
#     - name: SOME_ENV
#       value: some_value
actions:
  # available actions: close_issue, close_pr, merge_pr, add_comment, edit_comment, delete_comment, create_pr, label_issue, label_pr, create_issue, 
  # checkout_branch, agent_run, status_checks, emit_event
  - type: label_issue 
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [package_install_completed]
      remove_labels: [package_install_in_progress]
  - type: add_comment # available actions: close_issue, close_pr, merge_pr, add_comment, edit_comment, delete_comment
    env: 
      - name: SOME_ENV
        value: some_value
    params:
      comment: "installing a5c packages for #${{ event.issue.number }}"
  - type: agent_run
    env: 
      - name: SOME_ENV
        value: some_value
    params:
      some_param: some_value
  - type: close_issue # available actions: close_issue, close_pr, merge_pr, add_comment, edit_comment, delete_comment
    params:
      issue: ${{ event.issue.html_url }}
  - type: add_comment # available actions: close_issue, close_pr, merge_pr, add_comment, edit_comment, delete_comment
    env: 
      - name: SOME_ENV
        value: some_value
    params:
      comment: "a5c packages for #${{ event.issue.number }} installed"          
      issue: ${{ event.issue.html_url }}
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [package_install_completed]
      remove_labels: [package_install_in_progress]
