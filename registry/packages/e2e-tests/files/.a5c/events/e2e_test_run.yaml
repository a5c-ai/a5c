---
name: Auto tag e2e test run issues
metadata:
  runner-name: reactor
on:
  issue:
    filters:
      - expression: ${{ event.type == 'opened' && event.label.name == 'e2e-test-run' }}
actions:
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [e2e-test-run-requested]
  - type: add_comment
    params:
      issue: ${{ event.issue.html_url }}
      comment: "E2E test run requested for issue #${{ event.issue.number }}"
---
name: E2E test run via slash command
metadata:
  runner-name: reactor
on:
  issue:
    filters:
      # e2e test run requested via label or slash command
      - expression: ${{ event.type == 'labeled' && event.label.name == 'e2e_test_run' }}
      - expression: ${{ event.enriched.slash_commands | map(command) | contains('run-e2e') }}
    skip:
      # is a issue or already closed
      - expression: ${{ event.issue.closed == true }}
      # if e2e test run in progress or already requested
      - expression: ${{ event.issue.labels | map(attribute='name') | contains('e2e_test_run_in_progress') || event.issue.labels | map(attribute='name') | contains('e2e_test_run_queued') }}
emit:
  e2e_test_run_requested:
    type: e2e_test_run
    payload:
      original_event: ${{ event }}
      issue: ${{ event.issue }}
      among: 
        - 'bug'
        - 'feature'
        - 'documentation'
        - 'question'
        - 'enhancement'
        - 'devops'
        - 'security'
        - 'performance'
        - 'ux'
        - 'backend'
        - 'frontend'
        - 'database'
        - 'api'
        - 'infrastructure'
        - 'support'
        - 'feature_request'
actions:
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [e2e_test_run_queued]
---
name: E2E test run agent
metadata:
  runner-name: agents
on:
  e2e_test_run_requested:
actions:
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [e2e_test_run_in_progress]
      remove_labels: [e2e_test_run_queued]
  - type: agent_run
    env:
      - name: SOME_ENV
        value: some_value
    params: {}
  - type: label_issue
    params:
      issue: ${{ event.issue.html_url }}
      add_labels: [e2e_test_run_completed]
      remove_labels: [e2e_test_run_in_progress]
