---
name: PR implementation via slash command
metadata:
  runner-name: reactor
on:
  pull_request:
    filters:
      # implementation label was added or slash command invoked
      - expression: ${{ event.type == 'labeled' && event.label.name == 'pr_implementation' }}
      - expression: ${{ event.enriched.slash_commands | map(command) | contains('implement') }}
    skip:
      # is already merged
      - expression: ${{ event.pull_request.merged == true }}
      # if implement_pr in progress or already requested
      - expression: ${{ event.pull_request.labels | map(attribute='name') | contains('pr_implementation_in_progress') || event.pull_request.labels | map(attribute='name') | contains('pr_implementation_queued') }}
emit:
  pr_implementation_requested:
    type: pr_implementation
    payload:
      original_event: ${{ event }}
      pr_ref: ${{ event.pull_request.head.ref }}
      base_ref: ${{ event.pull_request.base.ref }}
      pull_request: ${{ event.pull_request }}
actions:
  - type: label_issue
    params:
      issue: ${{ event.pull_request.html_url }}
      add_labels: [pr_implementation_queued]
      remove_labels: [pr_implementation_completed]
---
name: PR implementation agent run
metadata:
  runner-name: agents
on:
  pr_implementation_requested:
actions:
  - type: label_issue
    params:
      issue: ${{ event.pull_request.html_url }}
      add_labels: [pr_implementation_in_progress]
      remove_labels: [pr_implementation_queued]
  - type: status_checks
    params:
      name: "Implement PR/${{ event.type }}"
      description: "Implement PR ({{ event.pull_request.title })"
      pull_request_url: ${{ event.pull_request.html_url }}
      status: queued
  - type: agent_run
    params: {}
    env:
      - name: SOME_ENV
        value: some_value
  - type: status_checks
    params:
      name: "Implement PR/${{ event.type }}"
      description: "Implement PR ({{ event.pull_request.title })"
      pull_request_url: ${{ event.pull_request.html_url }}
      status: success
  - type: label_issue
    params:
      issue: ${{ event.pull_request.html_url }}
      add_labels: [pr_implementation_completed]
      remove_labels: [pr_implementation_in_progress]
